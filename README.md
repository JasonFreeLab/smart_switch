# Smart switch 解决方案

### 介绍
`Smart switch` 为客户提供智能开关产品的解决方案。客户几乎不需要投入软件开发，即可以:  
- 支持阿里 <云智能> APP 一键配网
- 支持阿里 <云智能> APP 控制设备
- 支持阿里 <天猫精灵智能音箱> 控制设备
- 支持阿里 <天猫精灵智能音箱> 配网并控制设备
- 支持 LED/开关 控制
- 支持 OTA 升级
- 支持接入阿里天猫精灵平台

### 解决方案部署
#### 1.参考 [README](../../../README.md) 文档进行硬件准备、环境搭建、SDK 准备

#### 2.1 天猫精灵平台部署
在阿里[天猫精灵 IoT 开放平台](https://iot.aligenie.com/)创建产品，参考[文档中心](https://www.aligenie.com/doc/357554?spm=a2140w.13129968.0.0.375d643bSuDL93)。

添加新产品

新增开关实例产品

选择品牌，输入产品名称，型号

选择产品标准功能

下一步进入人机交互，按照自己需求添加配网引导

进入设备调试，查看三元组信息，选择其中一行三元组

其中 ProductSecret 对应该产品标识符。

进入软件发布，获取配网二维码，使用 APP 进行配网

#### 2.2 阿里云平台部署
在阿里云 [生活物联网平台](https://living.aliyun.com/#/) 创建产品，参考[创建产品文档](https://living.aliyun.com/doc#readygo.html)。
> 配置较多，如果不太懂，也不用纠结，后续都可以修改。

部署自己的产品，可参考如下:
新增功能

新增测试设备，此处即可以获得`三元组`，后续需要烧录到 NVS 分区.

选择面板，手机 APP 上会显示同样界面; `配网二维码`是贴在产品包装上，终端客户给设备配网中需扫描此二维码。

选择面板时，主题面板在手机上仅能显示标准界面，没有 RGB 调色功能。可以自定义面板，增加 RGB 调色。

配网方案选择:

完成

2.1 和 2.2 两个平台只需要按照一个进行配置。

#### 3.下载本工程
   ```
    git clone https://github.com/JasonFreeLab/esp-ali-smartliving.git
    git clone https://github.com/JasonFreeLab/smart_switch.git
    cd esp-ali-smartliving
   ```

#### 4.烧录三元组信息
- 参考 [量产说明](../../../config/mass_mfg/README.md) 文档烧录三元组 NVS 分区。

> 如果执行了 `make erase_flash`，需要重新烧录三元组。

#### 5.配置 `smart switch`
- LED 开关分别接 ESP32 & ESP32S2/ESP8266 开发板上 `GPIO4`，`GPIO5`(可在 `led.c` `switch.c` 中修改)

#### 6.编译 `smart switch` 并烧录运行
```
cd smart_switch
make defconfig 或者 make defconfig
make -j8 flash monitor
```

> 在测试配网中，请先执行 `make erase_flash` .

#### 7.设备第一次运行时，会进入配网

#### 8.如果是在生活物联网平台创建的产品，手机从[阿里云官网](https://living.aliyun.com/doc#muti-app.html) 下载 `云智能` 公版 APP，国内用户版;如果是在天猫精灵IoT平台创建的产品，手机从应用商城下载天猫精灵APP。

#### 9.注册好账号后，进入 APP，右上角扫描，扫描第二步的二维码配网。
设备端配网成功后会保存 `ssid` 和 `password`

设备与手机绑定成功后，APP 上会弹出开关的配置页面。返回主页显示开关 `在线`。

#### 10.控制智能开关

在 APP 上打开开关，设备端收到消息

#### 11.重新配网
快速重启设备 5 次，设备会擦除配置信息，重新进入配网状态。

可以配置快速重启的次数和超时时间。
```
cd smart_switch
make menuconfig
```

#### 12.OTA 支持
参考 examples/ota/ota_example_mqtt 示例下的 [README](../../ota/ota_example_mqtt/README.md) ，向管理控制台上传固件，验证固件后，下发升级指令。
设备端收到升级指令后，即开始 OTA

升级完成后，会检查固件的有效性。

iotkit-embedded 目前没有设置软重启操作，可以手动按模组重启键运行新固件

#### 13.天猫精灵
##### 13.1 天猫精灵控制设备
针对使用公版 APP 的产品，用户可以一键开通天猫精灵，实现天猫精灵音箱对设备的控制。使用步骤参照[阿里云文档](https://living.aliyun.com/doc#TmallGenie.html)。
- 在阿里云 [生活物联网平台](https://living.aliyun.com/#/)上一键开通天猫精灵，查看功能映射。
- 在 `云智能` [公版 APP]((https://living.aliyun.com/doc#muti-app.html))上绑定天猫精灵账号(即淘宝账号)。 

注意最后步骤，否则天猫精灵无法找到设备:
> 在天猫精灵 APP 找到 "阿里智能" 技能，手动进行 "尝试" 或 "设备同步"(后期会进行自动同步)  
> 即可在 "我家" 的设备列表中看到您的设备

完成以上步骤后，您可以通过天猫精灵音箱控制您的设备了。您可以对天猫精灵说 "天猫精灵,开开关"，"天猫精灵，关开关"，"天猫精灵，把开关调成红色" 或者其他您希望设置的颜色，设备即响应相应的命令。

##### 13.2 天猫精灵配网并控制设备
阿里云设备支持 `零配` 的配网方式。 
使设备进入配网状态，对天猫精灵说 "天猫精灵,发现设备"  
天猫精灵回复 "正在为您扫描，发现了智能开关，现在连接吗"  
对天猫精灵说 "连接" 或者 "是的"  
天猫精灵回复 "好的，设备连接中，稍等一下下哦"  
设备收到天猫精灵发送的管理帧配网信息，进行联网

等待联网成功，天猫精灵说 "智能设备联网成功，现在用语音控制它试试"，这时您可以通过天猫精灵音箱控制您的设备了。

如果您之前通过云智能 APP 配网，天猫精灵配网成功后，云智能 APP 将不再显示设备。 如果继续通过云智能 APP 配网，APP 会配网失败，显示 "设备添加失败，设备已被管理员绑定，请联系管理员解绑或将设备分享给您"。
> 在天猫精灵 APP 删除设备，云智能 APP 再进行配网可以配置成功并显示设备。
